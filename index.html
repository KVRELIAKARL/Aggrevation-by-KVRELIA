<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggravating Platformer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        canvas {
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 24px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-size: 16px;
            font-weight: 500;
        }
        #restart {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        #restart:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        #restart:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div id="ui">Level: 1 | Lives: 3</div>
    <button id="restart">Restart</button>
    <canvas id="gameCanvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        // Matter.js Setup
        const Engine = Matter.Engine,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body;

        const engine = Engine.create();
        engine.world.gravity.y = 1;

        // Game State
        let player, platforms = [], hazards = [], goals = [];
        let currentLevel = 1;
        let lives = 3;
        let isGameOver = false;
        let keys = {};
        let jelloTimer = 0;
        let isGrounded = false;
        let particles = [];

        // Player Properties
        const playerRadius = 15;
        const jumpForce = -10;
        const moveSpeed = 3;
        const maxVelocity = 5;

        // Particle System for Jump/Land Effects
        function createParticles(x, y, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    radius: Math.random() * 3 + 1,
                    life: 1,
                    color: `rgba(0, 122, 255, ${Math.random() * 0.5 + 0.5})`
                });
            }
        }

        function updateParticles() {
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.radius *= 0.98;
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // Level Definitions
        const levels = [
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.3 },
                    { x: 200, y: 450, w: 150, h: 20, friction: 0.05 },
                    { x: 400, y: 350, w: 150, h: 20, friction: 0.05 },
                    { x: 600, y: 250, w: 150, h: 20, friction: 0.05 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 200, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 400, w: 100, h: 20, friction: 0.3, isMoving: true, range: { start: 100, end: 300, speed: 2 } },
                    { x: 500, y: 300, w: 100, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 400, y: 550, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 150, h: 20, restitution: 1.5 },
                    { x: 400, y: 300, w: 150, h: 20, restitution: 1.5 }
                ],
                hazards: [
                    { x: 300, y: 550, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 150, y: 450, w: 80, h: 15, friction: 0.2 },
                    { x: 350, y: 350, w: 80, h: 15, friction: 0.2 },
                    { x: 550, y: 250, w: 80, h: 15, friction: 0.2 }
                ],
                hazards: [
                    { x: 250, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 200, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 500, w: 100, h: 20, friction: 0.3 },
                    { x: 400, y: 300, w: 100, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 550, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 150, h: 20, friction: 0.3 },
                    { x: 500, y: 300, w: 150, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, isMoving: true, range: { start: 250, end: 450, speed: 3 } }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 450, w: 100, h: 20, friction: 0.3 },
                    { x: 400, y: 250, w: 100, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 100, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 450, w: 150, h: 20, friction: 0.01 },
                    { x: 400, y: 350, w: 150, h: 20, friction: 0.01 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 300, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 80, h: 20, friction: 0.3 },
                    { x: 400, y: 350, w: 80, h: 20, friction: 0.3 },
                    { x: 600, y: 300, w: 80, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 100, h: 20, restitution: 1.2 },
                    { x: 400, y: 350, w: 100, h: 20, restitution: 1.2 },
                    { x: 600, y: 300, w: 100, h: 20, restitution: 1.2 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 400, w: 100, h: 20, isMoving: true, range: { start: 100, end: 400, speed: 4 } },
                    { x: 500, y: 300, w: 100, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 150, h: 20, friction: 0.3 },
                    { x: 500, y: 300, w: 150, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 400, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 500, w: 100, h: 20, friction: 0.3 },
                    { x: 300, y: 400, w: 100, h: 20, friction: 0.3 },
                    { x: 400, y: 300, w: 100, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 250, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 500, y: 200, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 400, w: 100, h: 20, friction: 0.05, isMoving: true, range: { start: 100, end: 300, speed: 3 } },
                    { x: 400, y: 300, w: 100, h: 20, friction: 0.05 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 450, w: 60, h: 15, friction: 0.3 },
                    { x: 400, y: 350, w: 60, h: 15, friction: 0.3 },
                    { x: 600, y: 250, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 200, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 150, h: 20, friction: 0.3 },
                    { x: 500, y: 300, w: 150, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, restitution: 1.5 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 100, h: 20, friction: 0.3 },
                    { x: 600, y: 300, w: 100, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 400, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 150, h: 20, friction: 0.3 },
                    { x: 500, y: 300, w: 150, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 250, w: 30, h: 30, isMoving: true, range: { start: 550, end: 650, speed: 2 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 100, h: 20, friction: 0.3 },
                    { x: 400, y: 350, w: 100, h: 20, friction: 0.3 },
                    { x: 600, y: 300, w: 100, h: 20, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 400, y: 400, w: 50, h: 50 },
                    { x: 500, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 250, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 450, w: 80, h: 15, friction: 0.05, isMoving: true, range: { start: 100, end: 300, speed: 3 } },
                    { x: 400, y: 350, w: 80, h: 15, restitution: 1.5 },
                    { x: 600, y: 250, w: 80, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50, isMoving: true, range: { start: 250, end: 450, speed: 4 } },
                    { x: 500, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 200, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            }
        ];

        function loadLevel(levelIndex) {
            World.clear(engine.world);
            platforms = [];
            hazards = [];
            goals = [];
            isGrounded = false;

            const level = levels[Math.min(levelIndex - 1, levels.length - 1)];

            // Create Player with Jello Physics
            player = Bodies.circle(level.playerStart.x, level.playerStart.y, playerRadius, {
                friction: 0.3,
                frictionAir: 0.05,
                restitution: 0.8,
                density: 0.002
            });
            World.add(engine.world, player);

            // Create Platforms
            level.platforms.forEach(p => {
                const platform = Bodies.rectangle(p.x + p.w / 2, p.y - p.h / 2, p.w, p.h, {
                    isStatic: !p.isMoving,
                    friction: p.friction || 0.5,
                    restitution: p.restitution || 0
                });
                platforms.push({ body: platform, ...p });
                World.add(engine.world, platform);
            });

            // Create Hazards
            level.hazards.forEach(h => {
                const hazard = Bodies.rectangle(h.x + h.w / 2, h.y - h.h / 2, h.w, h.h, {
                    isStatic: !h.isMoving,
                    isSensor: true,
                    restitution: h.restitution || 0
                });
                hazards.push({ body: hazard, ...h });
                World.add(engine.world, hazard);
            });

            // Create Goal
            const goal = Bodies.rectangle(level.goal.x + level.goal.w / 2, level.goal.y - level.goal.h / 2, level.goal.w, level.goal.h, {
                isStatic: !level.goal.isMoving,
                isSensor: true
            });
            goals.push({ body: goal, ...level.goal });
            World.add(engine.world, goal);
        }

        // Input Handling
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
        });
        window.addEventListener('keyup', e => {
            keys[e.code] = false;
        });

        // Disable Mouse Input
        canvas.addEventListener('mousedown', e => e.preventDefault());
        canvas.addEventListener('click', e => e.preventDefault());
        canvas.addEventListener('contextmenu', e => e.preventDefault());

        // Restart Button
        document.getElementById('restart').addEventListener('click', () => {
            lives = 3;
            currentLevel = 1;
            isGameOver = false;
            loadLevel(currentLevel);
        });

        // Collision Detection
        Matter.Events.on(engine, 'collisionStart', event => {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if (bodyA === player || bodyB === player) {
                    const other = bodyA === player ? bodyB : bodyA;
                    if (hazards.some(h => h.body === other)) {
                        lives--;
                        if (lives <= 0) {
                            isGameOver = true;
                        } else {
                            Body.setPosition(player, levels[currentLevel - 1].playerStart);
                            Body.setVelocity(player, { x: 0, y: 0 });
                            createParticles(player.position.x, player.position.y, 10);
                        }
                    }
                    if (goals.some(g => g.body === other)) {
                        currentLevel++;
                        if (currentLevel > levels.length) {
                            isGameOver = true;
                        } else {
                            loadLevel(currentLevel);
                            createParticles(player.position.x, player.position.y, 15);
                        }
                    }
                    if (platforms.some(p => p.body === other)) {
                        isGrounded = true;
                        createParticles(player.position.x, player.position.y + playerRadius, 5);
                    }
                }
            });
        });

        Matter.Events.on(engine, 'collisionEnd', event => {
            event.pairs.forEach(pair => {
                if (pair.bodyA === player || pair.bodyB === player) {
                    if (platforms.some(p => p.body === (pair.bodyA === player ? pair.bodyB : pair.bodyA))) {
                        isGrounded = false;
                    }
                }
            });
        });

        // Update Moving Objects
        function updateMovingObjects() {
            platforms.forEach(p => {
                if (p.isMoving) {
                    const range = p.range;
                    const currentX = p.body.position.x;
                    const speed = range.speed;
                    if (currentX >= range.end) p.dir = -speed;
                    if (currentX <= range.start) p.dir = speed;
                    Body.setVelocity(p.body, { x: p.dir || speed, y: 0 });
                }
            });

            hazards.forEach(h => {
                if (h.isMoving) {
                    const range = h.range;
                    const currentX = h.body.position.x;
                    const speed = range.speed;
                    if (currentX >= range.end) h.dir = -speed;
                    if (currentX <= range.start) h.dir = speed;
                    Body.setVelocity(h.body, { x: h.dir || speed, y: 0 });
                }
            });

            goals.forEach(g => {
                if (g.isMoving) {
                    const range = g.range;
                    const currentX = g.body.position.x;
                    const speed = range.speed;
                    if (currentX >= range.end) g.dir = -speed;
                    if (currentX <= range.start) g.dir = speed;
                    Body.setVelocity(g.body, { x: g.dir || speed, y: 0 });
                }
            });
        }

        // Jello Physics Effect
        function updateJelloEffect() {
            jelloTimer += 0.05;
            const scale = 1 + 0.05 * Math.sin(jelloTimer);
            player.jelloScale = scale;
        }

        // Bounds Checking
        function keepPlayerInBounds() {
            const pos = player.position;
            if (pos.x < playerRadius) Body.setPosition(player, { x: playerRadius, y: pos.y });
            if (pos.x > canvas.width - playerRadius) Body.setPosition(player, { x: canvas.width - playerRadius, y: pos.y });
            if (pos.y < playerRadius) Body.setPosition(player, { x: pos.x, y: playerRadius });
            if (pos.y > canvas.height) {
                lives--;
                if (lives <= 0) {
                    isGameOver = true;
                } else {
                    Body.setPosition(player, levels[currentLevel - 1].playerStart);
                    Body.setVelocity(player, { x: 0, y: 0 });
                    createParticles(player.position.x, player.position.y, 10);
                }
            }
        }

        // Game Loop
        function gameLoop() {
            if (isGameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.font = '48px -apple-system';
                ctx.textAlign = 'center';
                ctx.fillText(lives <= 0 ? 'Game Over!' : 'You Win!', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Update Physics
            Engine.update(engine, 1000 / 60);

            // Player Movement
            let vx = player.velocity.x;
            if (keys['ArrowLeft']) {
                vx = -moveSpeed;
            } else if (keys['ArrowRight']) {
                vx = moveSpeed;
            } else {
                vx *= 0.8; // Friction when no input
            }
            Body.setVelocity(player, { x: Math.max(-maxVelocity, Math.min(maxVelocity, vx)), y: player.velocity.y });

            if (keys['Space'] && isGrounded) {
                Body.applyForce(player, player.position, { x: 0, y: jumpForce });
                isGrounded = false;
                createParticles(player.position.x, player.position.y + playerRadius, 10);
            }

            updateMovingObjects();
            updateJelloEffect();
            updateParticles();
            keepPlayerInBounds();

            // Rendering
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(74, 74, 74, 0.5)');
            gradient.addColorStop(1, 'rgba(44, 44, 44, 0.5)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Particles
            drawParticles();

            // Draw Platforms
            platforms.forEach(p => {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                ctx.beginPath();
                ctx.rect(p.body.position.x - p.w / 2, p.body.position.y - p.h / 2, p.w, p.h);
                ctx.fill();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.stroke();
                ctx.shadowColor = 'rgba(255, 255, 255, 0.2)';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Draw Hazards
            hazards.forEach(h => {
                ctx.fillStyle = 'rgba(255, 61, 61, 0.8)';
                ctx.beginPath();
                ctx.rect(h.body.position.x - h.w / 2, h.body.position.y - h.h / 2, h.w, h.h);
                ctx.fill();
                ctx.shadowColor = 'rgba(255, 61, 61, 0.5)';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Draw Goal
            goals.forEach(g => {
                ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                ctx.beginPath();
                ctx.rect(g.body.position.x - g.w / 2, g.body.position.y - g.h / 2, g.w, g.h);
                ctx.fill();
                ctx.shadowColor = 'rgba(0, 255, 0, 0.5)';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Draw Player with Jello Effect
            ctx.fillStyle = '#007aff';
            ctx.beginPath();
            const scale = player.jelloScale || 1;
            ctx.save();
            ctx.translate(player.position.x, player.position.y);
            ctx.scale(scale, 1 / scale);
            ctx.arc(0, 0, playerRadius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.stroke();
            ctx.shadowColor = 'rgba(0, 122, 255, 0.5)';
            ctx.shadowBlur = 20;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();

            // Update UI
            document.getElementById('ui').textContent = `Level: ${currentLevel} | Lives: ${lives}`;

            requestAnimationFrame(gameLoop);
        }

        // Initialize Game
        loadLevel(currentLevel);
        gameLoop();
    </script>
</body>
</html>
