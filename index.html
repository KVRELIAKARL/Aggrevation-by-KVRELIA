<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggravating Platformer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        canvas {
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 24px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-size: 16px;
            font-weight: 500;
        }
        #restart {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        #restart:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        #restart:active {
            transform: scale(0.95);
        }
        #taunt-box {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 250px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            color: #fff;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
            opacity: 0;
            transform: translateX(100px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        #taunt-box.visible {
            opacity: 1;
            transform: translateX(0);
        }
        #taunt-box img {
            width: 50px;
            height: 50px;
            margin-right: 12px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="ui">Level: 1 | Lives: 2</div>
    <button id="restart">Restart</button>
    <div id="taunt-box">
        <img src="https://imgur.com/iFSaxRp.png" alt="Taunting Character" onerror="this.src='https://via.placeholder.com/50';">
        <span id="taunt-text">Gonna mess this up again?</span>
    </div>
    <canvas id="gameCanvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        // Matter.js Setup
        const Engine = Matter.Engine,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body;

        const engine = Engine.create();
        engine.world.gravity.y = 1;

        // Game State
        let player, platforms = [], hazards = [], goals = [];
        let currentLevel = 1;
        let lives = 2;
        let isGameOver = false;
        let keys = {};
        let jelloTimer = 0;
        let isGrounded = false;
        let particles = [];
        let windTimer = 0;
        let inputBuffer = { left: false, right: false, jump: false, time: 0 };
        let screenShake = 0;
        let tauntTimer = 0;
        let lastAction = null;
        let idleTimer = 0;
        let userCity = null;
        let isHawaii = false;
        let isSpeaking = false;

        // Player Properties
        const playerRadius = 15;
        const jumpForce = -5.5; // Further reduced jump height
        const moveSpeed = 3;
        const maxVelocity = 5;
        const inputDelay = 30;

        // Geolocation
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`);
                            const data = await response.json();
                            userCity = data.address.city || data.address.town || 'somewhere';
                            isHawaii = data.address.state === 'Hawaii';
                            updateTaunt('location');
                        } catch {
                            userCity = null;
                            isHawaii = false;
                        }
                    },
                    () => {
                        userCity = null;
                        isHawaii = false;
                    }
                );
            }
        }
        getUserLocation();

        // Text-to-Speech
        function speak(text, pitch = 1.1, rate = 1.0) {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.pitch = pitch;
                utterance.rate = rate;
                utterance.onend = () => {
                    isSpeaking = false;
                    tauntTimer = 180; // 3 seconds at 60fps
                };
                isSpeaking = true;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Taunt System (Personal and City-Specific)
        const taunts = isHawaii ? [
            // Hawaii-Specific
            `Surfing in ${userCity || 'Hawaii'}’s easier than this, huh?`,
            `Bet you’re slower than a ${userCity || 'Hawaii'} turtle!`,
            `Crashing harder than waves in ${userCity || 'Hawaii'}!`,
            `Even ${userCity || 'Hawaii'}’s shave ice melts faster!`,
            `Lost in ${userCity || 'Hawaii'} like a tourist, huh?`,
            // Jump
            "That jump’s weaker than your hula skills!",
            "Jumping like you’re dodging lava flows!",
            "Nice leap, but you’re no Maui!",
            "Your jumps are as bad as your ukulele strums!",
            // Move
            "Running like you’re late for a luau!",
            "Moving slower than traffic in Honolulu!",
            "Left-right, still can’t keep up with me!",
            "You shuffle like you’re on island time!",
            // Hazard
            "Spikes got you? Should’ve stayed on the beach!",
            "Fell again? Watch out for coconuts next!",
            "Hazards love you more than aloha!",
            "Ouch, you’re not surviving this volcano!",
            // Idle
            "Chilling like you’re at a ${userCity || 'Hawaii'} beach? Move!",
            "What, napping under a palm tree?",
            "Frozen like you saw a menehune!",
            "Standing still? Scared of the tiki gods?",
            // Random
            "You’re embarrassing ${userCity || 'Hawaii'} right now!",
            "Bet you’d rather be eating loco moco!",
            "This is why I’m the cooler sibling!",
            "You’re flopping worse than a fish in ${userCity || 'Hawaii'}!",
            "Keep failing, it’s my daily entertainment!",
            "Your skills are as lost as Captain Cook!",
            "Mom’s gonna hear about this mess!",
            "You’re making ${userCity || 'Hawaii'} look bad!"
        ] : [
            // Generic City-Specific
            `Failing big in ${userCity || 'your town'}, huh?`,
            `Even ${userCity || 'your town'}’s traffic moves faster!`,
            `${userCity || 'Your town'} called, they’re embarrassed!`,
            // Jump
            "Your jumps are as bad as your last haircut!",
            "Jumping like you’re dodging chores!",
            "That leap’s weaker than your excuses!",
            "Nice try, but your jumps are a joke!",
            // Move
            "Running like you’re late for dinner again!",
            "Moving slower than your brain cells!",
            "Left-right, still can’t outrun me!",
            "You shuffle like you’re avoiding homework!",
            // Hazard
            "Spikes again? You’re a walking disaster!",
            "Fell off? You’re embarrassing us both!",
            "Hazards love you more than I do!",
            "Ouch, you’re a magnet for pain!",
            // Idle
            "Standing still? Scared I’ll beat you?",
            "What, napping instead of playing?",
            "Frozen like you saw my report card!",
            "Chilling like you’re avoiding me!",
            // Random
            "You’re flopping worse than your last test!",
            "This is why I’m Mom’s favorite!",
            "Keep failing, it’s my entertainment!",
            "Your skills are as bad as your room!",
            "Bet you’d rather be anywhere else!",
            "You’re making me look good!",
            "Wow, you’re bad at this, huh?",
            `Struggling in ${userCity || 'your town'}? Typical!`
        ];

        // Level Completion Voice Lines
        const completionTaunts = [
            "Ugh, you passed Level 1? I’m... shocked.",
            "Level 2 done? Okay, I was wrong, happy?",
            "Level 3 cleared? I’m eating my words...",
            "You got through Level 4? So embarrassing!",
            "Level 5? Fine, you’re not totally awful.",
            "Level 6 done? I underestimated you, ugh!",
            "Level 7 cleared? I’m red-faced here!",
            "Level 8? Okay, I doubted you, my bad.",
            "Level 9 done? I’m totally humiliated!",
            "Level 10? I was so wrong about you!",
            "Level 11 cleared? I’m mortified!",
            "Level 12 done? I can’t believe this!",
            "Level 13? I’m ashamed I doubted you!",
            "Level 14 cleared? I’m eating crow!",
            "Level 15 done? Okay, you proved me wrong!",
            "Level 16? I’m super embarrassed now!",
            "Level 17 cleared? I was way off!",
            "Level 18 done? I’m so wrong, ugh!",
            "Level 19? I can’t even right now!",
            "Level 20 cleared? I’m totally humiliated!"
        ];

        function updateTaunt(action = null) {
            if ((tauntTimer <= 0 && !isSpeaking) || action) {
                const tauntBox = document.getElementById('taunt-box');
                tauntBox.classList.remove('visible');
                setTimeout(() => {
                    let filteredTaunts = taunts;
                    if (action === 'jump') {
                        filteredTaunts = taunts.filter(t => t.includes('jump') || t.includes('Jump'));
                    } else if (action === 'move') {
                        filteredTaunts = taunts.filter(t => t.includes('left') || t.includes('right') || t.includes('moving') || t.includes('Move'));
                    } else if (action === 'hazard') {
                        filteredTaunts = taunts.filter(t => t.includes('spike') || t.includes('fell') || t.includes('hazard') || t.includes('fall'));
                    } else if (action === 'idle') {
                        filteredTaunts = taunts.filter(t => t.includes('still') || t.includes('idle'));
                    } else if (action === 'location' && (userCity || isHawaii)) {
                        filteredTaunts = taunts.filter(t => t.includes(userCity) || t.includes('Hawaii'));
                    }
                    const taunt = filteredTaunts[Math.floor(Math.random() * filteredTaunts.length)] || taunts[Math.floor(Math.random() * taunts.length)];
                    document.getElementById('taunt-text').textContent = taunt;
                    tauntBox.classList.add('visible');
                    speak(taunt);
                    tauntTimer = 300 + Math.random() * 300; // 5-10 seconds
                    lastAction = action;
                }, 500);
            }
            tauntTimer--;
        }

        // Particle System
        function createParticles(x, y, count, color = 'rgba(0, 122, 255, 0.7)') {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 5,
                    vy: (Math.random() - 0.5) * 5,
                    radius: Math.random() * 4 + 1,
                    life: 1,
                    color
                });
            }
        }

        function updateParticles() {
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.03;
                p.radius *= 0.97;
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // Level Definitions
        const levels = [
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.3 },
                    { x: 200, y: 450, w: 70, h: 15, friction: 0.05, isFragile: true },
                    { x: 400, y: 350, w: 70, h: 15, friction: 0.05 },
                    { x: 600, y: 250, w: 70, h: 15, friction: 0.05 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50, isMoving: true, range: { start: 250, end: 350, speed: 5 } },
                    { x: 450, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 400, w: 60, h: 15, friction: 0.3, isMoving: true, range: { start: 100, end: 250, speed: 4 } },
                    { x: 500, y: 300, w: 60, h: 15, friction: 0.3, isFragile: true }
                ],
                hazards: [
                    { x: 400, y: 550, w: 50, h: 50, isMoving: true, range: { start: 350, end: 450, speed: 5 } }
                ],
                goal: { x: 600, y: 180, w: 30, h: 30, isMoving: true, range: { start: 550, end: 650, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 400, w: 60, h: 15, restitution: 1.5, isShrinking: true },
                    { x: 400, y: 320, w: 60, h: 15, restitution: 1.5 }
                ],
                hazards: [
                    { x: 300, y: 550, w: 50, h: 50 },
                    { x: 350, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 150, y: 450, w: 50, h: 15, friction: 0.2, isFragile: true },
                    { x: 350, y: 350, w: 50, h: 15, friction: 0.2 },
                    { x: 550, y: 270, w: 50, h: 15, friction: 0.2 }
                ],
                hazards: [
                    { x: 250, y: 500, w: 50, h: 50, isMoving: true, range: { start: 200, end: 300, speed: 6 } }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 500, w: 60, h: 15, friction: 0.3, isShrinking: true },
                    { x: 400, y: 320, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 550, w: 50, h: 50 },
                    { x: 350, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 150, w: 30, h: 30, isMoving: true, range: { start: 550, end: 650, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 60, h: 15, friction: 0.3, isFragile: true },
                    { x: 500, y: 320, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, isMoving: true, range: { start: 250, end: 450, speed: 5 } }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 450, w: 50, h: 15, friction: 0.3, isShrinking: true },
                    { x: 400, y: 270, w: 50, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 },
                    { x: 350, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 150, w: 30, h: 30, isMoving: true, range: { start: 550, end: 650, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 450, w: 60, h: 15, friction: 0.01, isFragile: true },
                    { x: 400, y: 350, w: 60, h: 15, friction: 0.01 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50, isMoving: true, range: { start: 250, end: 350, speed: 6 } }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 50, h: 15, friction: 0.3 },
                    { x: 400, y: 350, w: 50, h: 15, friction: 0.3, isShrinking: true },
                    { x: 600, y: 320, w: 50, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 350, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30, isMoving: true, range: { start: 650, end: 750, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 60, h: 15, restitution: 1.2, isFragile: true },
                    { x: 400, y: 350, w: 60, h: 15, restitution: 1.2 },
                    { x: 600, y: 320, w: 60, h: 15, restitution: 1.2 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, isMoving: true, range: { start: 250, end: 450, speed: 5 } }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 420, w: 50, h: 15, isMoving: true, range: { start: 100, end: 300, speed: 5 } },
                    { x: 500, y: 320, w: 50, h: 15, friction: 0.3, isShrinking: true }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 },
                    { x: 350, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30, isMoving: true, range: { start: 650, end: 750, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 60, h: 15, friction: 0.3, isFragile: true },
                    { x: 500, y: 320, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, isMoving: true, range: { start: 250, end: 350, speed: 6 } },
                    { x: 400, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 500, w: 50, h: 15, friction: 0.3 },
                    { x: 300, y: 420, w: 50, h: 15, friction: 0.3, isShrinking: true },
                    { x: 400, y: 320, w: 50, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 250, y: 450, w: 50, h: 50 },
                    { x: 300, y: 500, w: 50, h: 50 }
                ],
                goal: { x: 500, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 420, w: 50, h: 15, friction: 0.05, isMoving: true, range: { start: 100, end: 250, speed: 5 } },
                    { x: 400, y: 320, w: 50, h: 15, friction: 0.05, isFragile: true }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 },
                    { x: 350, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 450, w: 40, h: 15, friction: 0.3, isShrinking: true },
                    { x: 400, y: 350, w: 40, h: 15, friction: 0.3 },
                    { x: 600, y: 270, w: 40, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50, isMoving: true, range: { start: 250, end: 350, speed: 6 } }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30, isMoving: true, range: { start: 650, end: 750, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 60, h: 15, friction: 0.3, isFragile: true },
                    { x: 500, y: 320, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, restitution: 1.5, isMoving: true, range: { start: 250, end: 450, speed: 5 } }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 50, h: 15, friction: 0.3 },
                    { x: 600, y: 320, w: 50, h: 15, friction: 0.3, isShrinking: true }
                ],
                hazards: [
                    { x: 400, y: 500, w: 50, h: 50, isMoving: true, range: { start: 350, end: 450, speed: 6 } },
                    { x: 450, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30, isMoving: true, range: { start: 650, end: 750, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 60, h: 15, friction: 0.3 },
                    { x: 500, y: 320, w: 60, h: 15, friction: 0.3, isFragile: true }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50 },
                    { x: 350, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 180, w: 30, h: 30, isMoving: true, range: { start: 550, end: 650, speed: 3 } },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 200, y: 420, w: 50, h: 15, friction: 0.3 },
                    { x: 400, y: 350, w: 50, h: 15, friction: 0.3, isShrinking: true },
                    { x: 600, y: 320, w: 50, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, isMoving: true, range: { start: 250, end: 350, speed: 6 } },
                    { x: 400, y: 400, w: 50, h: 50 },
                    { x: 500, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30 },
                playerStart: { x: 50, y: 500 }
            },
            {
                platforms: [
                    { x: 0, y: 600, w: 800, h: 50, friction: 0.5 },
                    { x: 100, y: 450, w: 40, h: 15, friction: 0.05, isMoving: true, range: { start: 100, end: 250, speed: 6 } },
                    { x: 400, y: 350, w: 40, h: 15, restitution: 1.5, isFragile: true },
                    { x: 600, y: 270, w: 40, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 500, w: 50, h: 50, isMoving: true, range: { start: 250, end: 450, speed: 6 } },
                    { x: 500, y: 450, w: 50, h: 50, isMoving: true, range: { start: 450, end: 550, speed: 6 } }
                ],
                goal: { x: 700, y: 180, w: 30, h: 30, isMoving: true, range: { start: 650, end: 750, speed: 4 } },
                playerStart: { x: 50, y: 500 }
            }
        ];

        function loadLevel(levelIndex) {
            World.clear(engine.world);
            platforms = [];
            hazards = [];
            goals = [];
            isGrounded = false;
            particles = [];
            updateTaunt();

            const level = levels[Math.min(levelIndex - 1, levels.length - 1)];

            // Create Player with Jello Physics
            player = Bodies.circle(level.playerStart.x, level.playerStart.y, playerRadius, {
                friction: 0.2,
                frictionAir: 0.07,
                restitution: 0.8,
                density: 0.004
            });
            World.add(engine.world, player);

            // Create Platforms
            level.platforms.forEach(p => {
                const platform = Bodies.rectangle(p.x + p.w / 2, p.y - p.h / 2, p.w, p.h, {
                    isStatic: !p.isMoving,
                    friction: p.friction || 0.5,
                    restitution: p.restitution || 0
                });
                platforms.push({ body: platform, ...p, originalW: p.w, shrinkTimer: 0, fragileTimer: p.isFragile ? null : null });
                World.add(engine.world, platform);
            });

            // Create Hazards
            level.hazards.forEach(h => {
                const hazard = Bodies.rectangle(h.x + h.w / 2, h.y - h.h / 2, h.w, h.h, {
                    isStatic: !h.isMoving,
                    isSensor: true,
                    restitution: h.restitution || 0
                });
                hazards.push({ body: hazard, ...h });
                World.add(engine.world, hazard);
            });

            // Create Goal
            const goal = Bodies.rectangle(level.goal.x + level.goal.w / 2, level.goal.y - level.goal.h / 2, level.goal.w, level.goal.h, {
                isStatic: !level.goal.isMoving,
                isSensor: true
            });
            goals.push({ body: goal, ...level.goal });
            World.add(engine.world, goal);
        }

        // Input Handling with Delay
        window.addEventListener('keydown', e => {
            if (e.code === 'ArrowLeft') {
                inputBuffer.left = true;
                updateTaunt('move');
            }
            if (e.code === 'ArrowRight') {
                inputBuffer.right = true;
                updateTaunt('move');
            }
            if (e.code === 'Space') {
                inputBuffer.jump = true;
                updateTaunt('jump');
            }
            inputBuffer.time = Date.now();
            idleTimer = 0;
        });
        window.addEventListener('keyup', e => {
            if (e.code === 'ArrowLeft') inputBuffer.left = false;
            if (e.code === 'ArrowRight') inputBuffer.right = false;
            if (e.code === 'Space') inputBuffer.jump = false;
        });

        // Disable Mouse Input
        canvas.addEventListener('mousedown', e => e.preventDefault());
        canvas.addEventListener('click', e => e.preventDefault());
        canvas.addEventListener('contextmenu', e => e.preventDefault());

        // Restart Button
        document.getElementById('restart').addEventListener('click', () => {
            lives = 2;
            currentLevel = 1;
            isGameOver = false;
            loadLevel(currentLevel);
            updateTaunt();
        });

        // Collision Detection
        Matter.Events.on(engine, 'collisionStart', event => {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if (bodyA === player || bodyB === player) {
                    const other = bodyA === player ? bodyB : bodyA;
                    if (hazards.some(h => h.body === other)) {
                        lives--;
                        updateTaunt('hazard');
                        if (lives <= 0) {
                            isGameOver = true;
                        } else {
                            Body.setPosition(player, levels[currentLevel - 1].playerStart);
                            Body.setVelocity(player, { x: 0, y: 0 });
                            createParticles(player.position.x, player.position.y, 15, 'rgba(255, 61, 61, 0.7)');
                        }
                    }
                    if (goals.some(g => g.body === other)) {
                        const taunt = completionTaunts[currentLevel - 1];
                        document.getElementById('taunt-text').textContent = taunt;
                        document.getElementById('taunt-box').classList.add('visible');
                        speak(taunt, 0.9, 0.9);
                        currentLevel++;
                        if (currentLevel > levels.length) {
                            isGameOver = true;
                        } else {
                            loadLevel(currentLevel);
                            createParticles(player.position.x, player.position.y, 20, 'rgba(0, 255, 0, 0.7)');
                        }
                    }
                    const platform = platforms.find(p => p.body === other);
                    if (platform) {
                        isGrounded = true;
                        createParticles(player.position.x, player.position.y + playerRadius, 8);
                        if (platform.isFragile && platform.fragileTimer === null) {
                            platform.fragileTimer = 60;
                            screenShake = 10;
                        }
                    }
                }
            });
        });

        Matter.Events.on(engine, 'collisionEnd', event => {
            event.pairs.forEach(pair => {
                if (pair.bodyA === player || pair.bodyB === player) {
                    if (platforms.some(p => p.body === (pair.bodyA === player ? pair.bodyB : pair.bodyA))) {
                        isGrounded = false;
                    }
                }
            });
        });

        // Update Moving Objects
        function updateMovingObjects() {
            platforms.forEach(p => {
                if (p.isMoving) {
                    const range = p.range;
                    const currentX = p.body.position.x;
                    const speed = range.speed;
                    if (currentX >= range.end) p.dir = -speed;
                    if (currentX <= range.start) p.dir = speed;
                    Body.setVelocity(p.body, { x: p.dir || speed, y: 0 });
                }
            });

            hazards.forEach(h => {
                if (h.isMoving) {
                    const range = h.range;
                    const currentX = h.body.position.x;
                    const speed = range.speed;
                    if (currentX >= range.end) h.dir = -speed;
                    if (currentX <= range.start) h.dir = speed;
                    Body.setVelocity(h.body, { x: h.dir || speed, y: 0 });
                }
            });

            goals.forEach(g => {
                if (g.isMoving) {
                    const range = g.range;
                    const currentX = g.body.position.x;
                    const speed = range.speed * (Math.random() < 0.05 ? -1 : 1);
                    if (currentX >= range.end) g.dir = -Math.abs(speed);
                    if (currentX <= range.start) g.dir = Math.abs(speed);
                    Body.setVelocity(g.body, { x: g.dir || speed, y: 0 });
                }
            });
        }

        // Update Fragile and Shrinking Platforms
        function updatePlatforms() {
            platforms.forEach(p => {
                if (p.isFragile && p.fragileTimer !== null) {
                    p.fragileTimer--;
                    if (p.fragileTimer <= 0) {
                        World.remove(engine.world, p.body);
                        platforms = platforms.filter(platform => platform !== p);
                        createParticles(p.body.position.x, p.body.position.y, 10);
                    }
                }
                if (p.isShrinking) {
                    p.shrinkTimer++;
                    p.w = Math.max(20, p.originalW - p.shrinkTimer * 0.1);
                    Body.scale(p.body, p.w / p.originalW, 1);
                    p.originalW = p.w;
                }
            });
        }

        // Jello Physics Effect
        function updateJelloEffect() {
            jelloTimer += 0.07;
            const scale = 1 + 0.07 * Math.sin(jelloTimer);
            player.jelloScale = scale;
        }

        // Random Wind Gusts
        function updateWind() {
            windTimer++;
            if (Math.random() < 0.01) {
                const windForce = (Math.random() - 0.5) * 0.05;
                Body.applyForce(player, player.position, { x: windForce, y: 0 });
                createParticles(player.position.x, player.position.y, 5, 'rgba(255, 255, 255, 0.3)');
            }
        }

        // Bounds Checking
        function keepPlayerInBounds() {
            const pos = player.position;
            if (pos.x < playerRadius) Body.setPosition(player, { x: playerRadius, y: pos.y });
            if (pos.x > canvas.width - playerRadius) Body.setPosition(player, { x: canvas.width - playerRadius, y: pos.y });
            if (pos.y < playerRadius) Body.setPosition(player, { x: pos.x, y: playerRadius });
            if (pos.y > canvas.height) {
                lives--;
                updateTaunt('hazard');
                if (lives <= 0) {
                    isGameOver = true;
                } else {
                    Body.setPosition(player, levels[currentLevel - 1].playerStart);
                    Body.setVelocity(player, { x: 0, y: 0 });
                    createParticles(player.position.x, player.position.y, 15, 'rgba(255, 61, 61, 0.7)');
                }
            }
        }

        // Game Loop
        function gameLoop() {
            if (isGameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.font = '48px -apple-system';
                ctx.textAlign = 'center';
                ctx.fillText(lives <= 0 ? 'Game Over!' : 'You Win!', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Update Physics
            Engine.update(engine, 1000 / 60);

            // Player Movement with Input Delay
            const now = Date.now();
            if (now - inputBuffer.time >= inputDelay) {
                let vx = player.velocity.x;
                if (inputBuffer.left) {
                    vx = -moveSpeed;
                } else if (inputBuffer.right) {
                    vx = moveSpeed;
                } else {
                    vx *= 0.7;
                }
                Body.setVelocity(player, { x: Math.max(-maxVelocity, Math.min(maxVelocity, vx)), y: player.velocity.y });

                if (inputBuffer.jump && isGrounded) {
                    Body.applyForce(player, player.position, { x: 0, y: jumpForce });
                    isGrounded = false;
                    createParticles(player.position.x, player.position.y + playerRadius, 12);
                }
            }

            // Idle Check
            if (!inputBuffer.left && !inputBuffer.right && !inputBuffer.jump) {
                idleTimer++;
                if (idleTimer > 180) {
                    updateTaunt('idle');
                    idleTimer = 0;
                }
            } else {
                idleTimer = 0;
            }

            updateMovingObjects();
            updatePlatforms();
            updateJelloEffect();
            updateWind();
            updateParticles();
            updateTaunt();
            keepPlayerInBounds();

            // Rendering with Screen Shake
            ctx.save();
            if (screenShake > 0) {
                ctx.translate((Math.random() - 0.5) * 5, (Math.random() - 0.5) * 5);
                screenShake--;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(74, 74, 74, 0.5)');
            gradient.addColorStop(1, 'rgba(44, 44, 44, 0.5)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Particles
            drawParticles();

            // Draw Platforms
            platforms.forEach(p => {
                ctx.fillStyle = p.isFragile ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.15)';
                ctx.beginPath();
                ctx.rect(p.body.position.x - p.w / 2, p.body.position.y - p.h / 2, p.w, p.h);
                ctx.fill();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.stroke();
                ctx.shadowColor = 'rgba(255, 255, 255, 0.2)';
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Draw Hazards
            hazards.forEach(h => {
                ctx.fillStyle = `rgba(255, 61, 61, ${0.8 + 0.2 * Math.sin(jelloTimer)})`;
                ctx.beginPath();
                ctx.rect(h.body.position.x - h.w / 2, h.body.position.y - h.h / 2, h.w, h.h);
                ctx.fill();
                ctx.shadowColor = 'rgba(255, 61, 61, 0.5)';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Draw Goal
            goals.forEach(g => {
                ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                ctx.beginPath();
                ctx.rect(g.body.position.x - g.w / 2, g.body.position.y - g.h / 2, g.w, g.h);
                ctx.fill();
                ctx.shadowColor = 'rgba(0, 255, 0, 0.5)';
                ctx.shadowBlur = 15;
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Draw Player with Jello Effect
            ctx.fillStyle = '#007aff';
            ctx.beginPath();
            const scale = player.jelloScale || 1;
            ctx.save();
            ctx.translate(player.position.x, player.position.y);
            ctx.scale(scale, 1 / scale);
            ctx.arc(0, 0, playerRadius, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.stroke();
            ctx.shadowColor = 'rgba(0, 122, 255, 0.5)';
            ctx.shadowBlur = 20;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();

            // Update UI
            document.getElementById('ui').textContent = `Level: ${currentLevel} | Lives: ${lives}`;

            ctx.restore();
            requestAnimationFrame(gameLoop);
        }

        // Initialize Game
        loadLevel(currentLevel);
        document.getElementById('taunt-box').classList.add('visible');
        gameLoop();
    </script>
</body>
</html>
