<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggrevation By KVRELIA</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1e1e2f, #2c2c3e);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        canvas {
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            display: none;
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 24px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-size: 16px;
            font-weight: 500;
            display: none;
        }
        #restart {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: none;
        }
        #restart:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        #restart:active {
            transform: scale(0.95);
        }
        #taunt-box {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 250px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            color: #fff;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.4;
            opacity: 0;
            transform: translateX(100px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            display: none;
        }
        #taunt-box.visible {
            opacity: 1;
            transform: translateX(0);
        }
        #taunt-box img {
            width: 50px;
            height: 50px;
            margin-right: 12px;
            border-radius: 8px;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30, 30, 47, 0.9), rgba(44, 44, 62, 0.9));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #start-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5), inset 0 1px 1px rgba(255, 255, 255, 0.1);
            color: #fff;
            max-width: 700px;
            text-align: left;
            font-size: 16px;
            line-height: 1.6;
            position: relative;
        }
        #start-content::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 12px;
            width: 12px;
            height: 12px;
            background: #ff5f56;
            border-radius: 50%;
            box-shadow: 20px 0 0 #ffbd2e, 40px 0 0 #27c93f;
        }
        #start-content h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #ffffff;
        }
        #start-content p, #start-content ul {
            margin: 0;
            padding: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #start-content p.visible, #start-content ul.visible {
            opacity: 1;
        }
        #start-content ul {
            margin: 20px 0;
            padding-left: 24px;
        }
        #start-content li {
            margin-bottom: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #start-content li.visible {
            opacity: 1;
        }
        #start-button {
            display: none;
            margin-top: 24px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #007aff, #005bb5);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 500;
            transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 100%;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        #start-button.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #start-button:hover {
            background: linear-gradient(135deg, #3395ff, #0072ff);
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 24px rgba(0, 122, 255, 0.5);
        }
        #start-button:active {
            transform: scale(0.95) translateY(0);
        }
        #blackout-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 5;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #flashlight {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 6;
            display: none;
        }
        #disclaimer-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 16px;
            background: rgba(255, 95, 86, 0.2);
            color: #ff5f56;
            border: 1px solid rgba(255, 95, 86, 0.4);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        #disclaimer-button:hover {
            background: rgba(255, 95, 86, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        #disclaimer-button:active {
            transform: translateY(0);
            background: rgba(255, 95, 86, 0.4);
        }
        #sana-rant {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1e1e2f;
            color: white;
            padding: 40px;
            overflow-y: auto;
            z-index: 20;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
        }
        #sana-rant h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #ff5f56;
        }
        #sana-rant-content {
            max-width: 800px;
            margin: 0 auto;
        }
        #sana-rant p {
            margin-bottom: 20px;
        }
        #cursor-lock {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 9999;
            display: none;
        }
        #stuck-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 95, 86, 0.8);
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 24px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 1000;
            display: none;
            animation: scrollText 10s linear infinite;
        }
        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        #notification-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 95, 86, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            text-align: center;
            max-width: 80%;
        }
        #notification-box button {
            background: white;
            color: #ff5f56;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <div id="start-content">
            <h1>Welcome to Aggrevation By KVRELIA</h1>
            <p id="intro-1">Game Mechanics:</p>
            <ul id="intro-2">
                <li id="intro-2-1">Objective: Reach the green goal in each of the 20 levels.</li>
                <li id="intro-2-2">Controls: Use Arrow Left/Right to move, Space to jump.</li>
                <li id="intro-2-3">Lives: You have 2 lives. Hit hazards or fall off to lose one.</li>
                <li id="intro-2-4">Challenges: Watch for moving hazards, fragile or shrinking platforms, and erratic goals.</li>
                <li id="intro-2-5">Taunts: Expect corporate performance reviews targeting your inefficiencies and city metrics!</li>
                <li id="intro-2-6">Blackout Events: Random power outages will occur - use your mouse to shine a flashlight!</li>
            </ul>
            <p id="intro-3">Team Directive:</p>
            <p id="intro-4">Aiden, Get your freaky chatbot Derrière out of this room.</p>
            <p id="intro-5">Sana, (Do NOT click the Disclaimer button in the corner)</p>
            <p id="intro-6">Abad Clone 1 and 2 stop playing goddamn Friday Night Funkin'!</p>
            <p id="intro-7">Ethan.... Bombardillo Crocodillo.</p>
            <p id="intro-8">What do you mean Karl Wrote This?! ITS ALL PHOEBE!</p>
            <button id="start-button">Start Game</button>
        </div>
    </div>
    <button id="disclaimer-button">Disclaimer</button>
    <div id="sana-rant">
        <div id="sana-rant-content">
            <h2>The History of Car Culture</h2>
            <p>Early Beginnings and the Birth of the Automobile (Late 19th Century)</p>
            <p>The roots of car culture trace back to the late 19th century when the automobile emerged as a revolutionary invention. Karl Benz's 1886 Motorwagen, often considered the first true automobile, marked a turning point, powered by an internal combustion engine. Early vehicles were novelties, hand-crafted and accessible only to the wealthy elite. They symbolized innovation and status, but their unreliability and the lack of infrastructure—roads were designed for horse-drawn carriages—limited their practicality. Enthusiasts, however, saw potential beyond utility. In Europe, particularly France, early motor clubs like the Automobile Club de France (founded in 1895) organized races and rallies, fostering a sense of adventure and competition. These events laid the groundwork for a culture that celebrated speed, engineering, and individuality, even as cars remained a niche fascination.</p>
            
            <p>The Mass Production Revolution and Democratization (1900s–1920s)</p>
            <p>The early 20th century transformed cars from luxury items to mass-market products, largely due to Henry Ford's introduction of the Model T in 1908 and the assembly line in 1913. Affordable and reliable, the Model T made car ownership accessible to the middle class in the United States, with over 15 million units sold by 1927. This democratization sparked the first waves of car culture as ownership became a symbol of freedom and opportunity. In the U.S., the car enabled suburban growth and cross-country travel, epitomized by the creation of Route 66 in 1926. Meanwhile, automotive design began to reflect personality, with brands like Cadillac and Packard offering luxury models for the affluent. Car clubs and amateur racing grew, particularly in the U.S. and Europe, as enthusiasts modified vehicles for performance, planting the seeds of customization culture.</p>
            
            <p>The Rise of Car Culture in the Interwar Period (1920s–1930s)</p>
            <p>The interwar years saw car culture diversify and deepen. In the U.S., the Roaring Twenties brought economic prosperity, and cars became central to social life, from Sunday drives to the rise of drive-in restaurants. Hollywood amplified this, with films showcasing sleek cars as symbols of glamour. In Europe, grand prix racing gained prominence, with manufacturers like Bugatti and Alfa Romeo pushing engineering boundaries. The Great Depression slowed growth but didn't kill enthusiasm; instead, it spurred ingenuity. In the U.S., "hot rodding" emerged as young enthusiasts modified cheap, used cars (often Model Ts or As) for speed, racing them on dry lake beds in California. This DIY ethos became a cornerstone of car culture, emphasizing creativity and rebellion against mainstream conformity.</p>
            
            <p>Post-War Boom and the Golden Age (1940s–1950s)</p>
            <p>World War II paused civilian car production, but the post-war economic boom ignited an unprecedented era for car culture. In the U.S., returning veterans with technical skills and a thirst for excitement fueled the hot rod scene. Southern California became the epicenter, with organizations like the Southern California Timing Association formalizing drag racing. The 1950s also saw the rise of muscle cars, with Detroit's Big Three (Ford, GM, Chrysler) producing powerful V8s like the Chevrolet Bel Air and Pontiac GTO. Cars became central to youth culture, celebrated in films like Rebel Without a Cause (1955) and songs like Chuck Berry's "Maybellene." Drive-in theaters and burger joints catered to car-centric lifestyles. In Europe, sports cars like the Porsche 356 and Jaguar XK120 captivated enthusiasts, while events like the Mille Miglia race reinforced cars as symbols of prestige and performance.</p>
            
            <p>The 1960s: Muscle Cars, Imports, and Counterculture</p>
            <p>The 1960s marked a high point for car culture, driven by diversity and global influences. In the U.S., muscle cars peaked with iconic models like the Ford Mustang (introduced in 1964) and Dodge Charger, offering affordable power for everyday drivers. Drag strips and car shows proliferated, while magazines like Hot Rod and Car and Driver connected enthusiasts. Simultaneously, European and Japanese imports gained traction. Cars like the Volkswagen Beetle and Datsun 510 appealed to those seeking economy and reliability, often tied to the counterculture's rejection of Detroit's excess. The British Invasion brought stylish sports cars like the MG and Triumph, while rally racing grew in Europe with events like the Monte Carlo Rally. Car culture became a battleground of ideals: American power versus European finesse and Japanese efficiency.</p>
            
            <p>Challenges and Evolution in the 1970s</p>
            <p>The 1970s posed challenges to car culture due to the 1973 oil crisis and stricter emissions regulations. In the U.S., muscle cars waned as manufacturers detuned engines to meet new standards, leading to a "malaise era" of underpowered vehicles. However, car culture adapted. Lowrider culture, rooted in Mexican-American communities, flourished, with customized cars featuring hydraulic suspensions and elaborate paint jobs. In Japan, a burgeoning tuning scene emerged, with enthusiasts modifying cars like the Nissan Skyline for street racing. The rise of motorsports like Formula 1 and NASCAR kept performance culture alive, while the introduction of the Honda Civic in 1972 signaled Japan's growing influence. Car culture became more inclusive, embracing diverse subcultures from street racing to off-roading.</p>
            
            <p>The 1980s and 1990s: Technology and Globalization</p>
            <p>The 1980s and 1990s saw car culture globalize, driven by technological advances and cultural exchange. In the U.S., the "tuner" scene exploded, inspired by Japanese imports like the Toyota Supra and Mazda RX-7. Movies like The Fast and the Furious (2001) popularized this subculture, emphasizing modifications and street racing. In Europe, "hot hatches" like the Volkswagen Golf GTI offered practical performance, spawning a new enthusiast base. Meanwhile, luxury and supercar culture surged, with icons like the Ferrari F40 and Lamborghini Countach captivating imaginations. Car shows, video games like Gran Turismo, and the internet connected global enthusiasts, creating online forums and communities. Drifting, born in Japan's mountain roads, became a worldwide phenomenon, blending skill and style.</p>
            
            <p>The 2000s: Digital Age and Environmental Shifts</p>
            <p>The 2000s brought car culture into the digital age. Social media platforms like YouTube and Instagram allowed enthusiasts to share builds, races, and car meets instantly, amplifying subcultures like stance (lowered cars with extreme wheel fitments) and overlanding (off-road adventure rigs). The relaunch of muscle cars like the Dodge Challenger and eco-friendly hybrids like the Toyota Prius reflected polarized priorities. Electric performance cars, notably Tesla's Roadster (2008), challenged traditional notions of speed. Car culture faced criticism for environmental impact, yet enthusiasts responded with innovations like biofuel conversions. Events like SEMA (Specialty Equipment Market Association) and global car meets underscored the industry's economic clout, while reality TV shows like Pimp My Ride brought customization to mainstream audiences.</p>
            
            <p>The 2010s: Electrification and Nostalgia</p>
            <p>The 2010s balanced nostalgia with forward-thinking. Retro-inspired designs like the Fiat 500 and Dodge Viper revival tapped into heritage, while electric vehicles (EVs) gained mainstream traction. Tesla's Model S and Model 3 redefined performance, proving EVs could rival gas-powered icons. Autonomous driving technology sparked debates about the future of driving, with purists defending manual transmissions and analog experiences. Car culture diversified further, with women and minority groups gaining visibility in traditionally male-dominated spaces. YouTube channels like Mighty Car Mods and global events like Goodwood Festival of Speed bridged old and new. Subcultures like van life and overlanding surged, reflecting a desire for freedom and exploration amid urbanization.</p>
            
            <p>The 2020s and Beyond: A Dynamic Future</p>
            <p>As of 2025, car culture remains vibrant but at a crossroads. EVs dominate new car markets, with models like the Rivian R1T and Lucid Air pushing boundaries. Yet, internal combustion engines persist, with synthetic fuels and hydrogen offering potential lifelines. Car culture has fully embraced digital platforms, with virtual car shows and NFT-based collectibles emerging. Autonomous vehicles challenge the driver-centric ethos, but enthusiast communities—bolstered by events like Monterey Car Week and grassroots meets—remain defiant. Subcultures continue to evolve, from hypercar collectors to eco-conscious builders retrofitting classic cars with electric drivetrains. Car culture's core—passion, creativity, and community—endures, adapting to technological, social, and environmental shifts while celebrating its rich history.</p>
        </div>
    </div>
    <div id="cursor-lock"></div>
    <div id="stuck-message">haha... YOUR STUCK HERE!!!!</div>
    <div id="notification-box">
        <p>You can't do that! You must click the Disclaimer button first!</p>
        <button id="notification-ok">OK</button>
    </div>
    <div id="ui">Level: 1 | Lives: 2</div>
    <button id="restart">Restart</button>
    <div id="taunt-box">
        <img src="https://imgur.com/iFSaxRp.png" alt="Taunting Character" onerror="this.src='https://via.placeholder.com/50';">
        <span id="taunt-text">Your Q1 performance is unacceptable!</span>
    </div>
    <div id="blackout-overlay"></div>
    <div id="flashlight"></div>
    <canvas id="gameCanvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        // Initialize starting screen
        const introSegments = [
            { text: "Game Mechanics:", elementId: 'intro-1' },
            { text: "Objective: Reach the green goal in each of the 20 levels.", elementId: 'intro-2-1', isListItem: true },
            { text: "Controls: Use Arrow Left/Right to move, Space to jump.", elementId: 'intro-2-2', isListItem: true },
            { text: "Lives: You have 2 lives. Hit hazards or fall off to lose one.", elementId: 'intro-2-3', isListItem: true },
            { text: "Challenges: Watch for moving hazards, fragile or shrinking platforms, and erratic goals.", elementId: 'intro-2-4', isListItem: true },
            { text: "Taunts: Expect corporate performance reviews targeting your inefficiencies and city metrics!", elementId: 'intro-2-5', isListItem: true },
            { text: "Blackout Events: Random power outages will occur - use your mouse to shine a flashlight!", elementId: 'intro-2-6', isListItem: true },
            { text: "Team Directive:", elementId: 'intro-3' },
            { text: "Aiden, Get your freaky chatbot Derrière out of this room.", elementId: 'intro-4' },
            { text: "Sana, (Do NOT click the Disclaimer button in the corner)", elementId: 'intro-5' },
            { text: "Abad Clone 1 and 2 stop playing goddamn Friday Night Funkin'!", elementId: 'intro-6' },
            { text: "Ethan.... Bombardillo Crocodillo.", elementId: 'intro-7' },
            { text: "What do you mean Karl Wrote This?! ITS ALL PHOEBE!", elementId: 'intro-8' }
        ];

        function initializeStartScreen() {
            introSegments.forEach(({ text, elementId, isListItem }) => {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.warn(`Element ${elementId} not found`);
                    return;
                }
                element.textContent = text;
            });
        }

        // Sana rant functionality
        const disclaimerButton = document.getElementById('disclaimer-button');
        const sanaRant = document.getElementById('sana-rant');
        const startScreen = document.getElementById('start-screen');
        const cursorLock = document.getElementById('cursor-lock');
        const stuckMessage = document.getElementById('stuck-message');
        const notificationBox = document.getElementById('notification-box');
        const notificationOk = document.getElementById('notification-ok');
        let isRantActive = false;

        // Make start button do nothing and show notification
        const startButton = document.getElementById('start-button');
        if (startButton) {
            startButton.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Show notification
                notificationBox.style.display = 'block';
                
                // Force disclaimer button to be visible
                disclaimerButton.style.display = 'block';
                disclaimerButton.style.animation = 'pulse 0.5s infinite alternate';
                
                // Scroll disclaimer into view if needed
                disclaimerButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Create a pulsing animation for the disclaimer button
                const style = document.createElement('style');
                style.innerHTML = `
                    @keyframes pulse {
                        from { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 95, 86, 0.7); }
                        to { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 95, 86, 0); }
                    }
                `;
                document.head.appendChild(style);
            });
        }

        // Notification OK button
        if (notificationOk) {
            notificationOk.addEventListener('click', () => {
                notificationBox.style.display = 'none';
            });
        }

        if (disclaimerButton) {
            disclaimerButton.addEventListener('click', () => {
                isRantActive = true;
                sanaRant.style.display = 'block';
                startScreen.style.display = 'none';
                cursorLock.style.display = 'block';
                stuckMessage.style.display = 'block';
                
                // Show the stuck message
                stuckMessage.style.display = 'block';
                
                // Disable right click and keyboard shortcuts
                document.addEventListener('contextmenu', preventDefault);
                document.addEventListener('keydown', preventShortcuts);
                
                // Force cursor to bottom of screen
                const lockCursor = () => {
                    window.scrollTo(0, document.body.scrollHeight);
                };
                
                // Check cursor position every 100ms
                const cursorCheck = setInterval(lockCursor, 100);
                
                // Scroll disclaimer content into view
                sanaRant.scrollIntoView({ behavior: 'smooth' });
                
                // Speak the rant
                speakRant().then(() => {
                    // When rant is done, re-enable everything
                    clearInterval(cursorCheck);
                    document.removeEventListener('contextmenu', preventDefault);
                    document.removeEventListener('keydown', preventShortcuts);
                    cursorLock.style.display = 'none';
                    stuckMessage.style.display = 'none';
                    endRant();
                });
            });
        }

        function preventDefault(e) {
            e.preventDefault();
            return false;
        }

        function preventShortcuts(e) {
            // Block common escape keys (F12, Ctrl+W, Alt+F4, etc.)
            if (e.key === 'F12' || 
                (e.ctrlKey && e.key === 'w') || 
                (e.altKey && e.key === 'F4') ||
                e.key === 'Escape') {
                e.preventDefault();
                return false;
            }
        }

        function speakRant() {
            return new Promise((resolve) => {
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel();
                    
                    const rantContent = document.getElementById('sana-rant-content').textContent;
                    const utterance = new SpeechSynthesisUtterance(rantContent);
                    utterance.pitch = 1.0;
                    utterance.rate = 0.9;
                    
                    utterance.onend = () => {
                        resolve();
                    };
                    
                    utterance.onerror = () => {
                        // If speech fails, wait 30 seconds then resolve
                        setTimeout(resolve, 30000);
                    };
                    
                    window.speechSynthesis.speak(utterance);
                } else {
                    // If TTS isn't available, wait 30 seconds then resolve
                    setTimeout(resolve, 30000);
                }
            });
        }

        function endRant() {
            isRantActive = false;
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
            sanaRant.style.display = 'none';
            startScreen.style.display = 'flex';
            
            // Smooth transition to game
            setTimeout(() => {
                startScreen.style.opacity = '0';
                setTimeout(() => {
                    startScreen.style.display = 'none';
                    canvas.style.display = 'block';
                    const ui = document.getElementById('ui');
                    if (ui) ui.style.display = 'block';
                    const restart = document.getElementById('restart');
                    if (restart) restart.style.display = 'block';
                    const tauntBox = document.getElementById('taunt-box');
                    if (tauntBox) {
                        tauntBox.style.display = 'flex';
                        tauntBox.classList.add('visible');
                    }
                    loadLevel(currentLevel);
                    gameLoop();
                }, 500);
            }, 500);
        }

        function speakIntro() {
            if (window.speechSynthesis && !isSpeaking) {
                window.speechSynthesis.cancel();
                let currentSegment = 0;

                const speakNext = () => {
                    if (currentSegment >= introSegments.length) {
                        isSpeaking = false;
                        const startButton = document.getElementById('start-button');
                        if (startButton) {
                            startButton.classList.add('visible');
                            startButton.style.display = 'block';
                        }
                        return;
                    }

                    const { text, elementId, isListItem } = introSegments[currentSegment];
                    const element = document.getElementById(elementId);
                    if (!element) {
                        console.warn(`Element ${elementId} not found`);
                        currentSegment++;
                        setTimeout(speakNext, 500);
                        return;
                    }

                    try {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.pitch = 1.1;
                        utterance.rate = 1.0;

                        utterance.onstart = () => {
                            element.classList.add('visible');
                            if (isListItem) {
                                const parent = document.getElementById('intro-2');
                                if (parent) parent.classList.add('visible');
                            }
                        };

                        utterance.onend = () => {
                            isSpeaking = false;
                            currentSegment++;
                            setTimeout(speakNext, 500);
                        };

                        utterance.onerror = (e) => {
                            console.warn(`TTS error for segment ${currentSegment}:`, e);
                            element.classList.add('visible');
                            if (isListItem) {
                                const parent = document.getElementById('intro-2');
                                if (parent) parent.classList.add('visible');
                            }
                            isSpeaking = false;
                            currentSegment++;
                            setTimeout(speakNext, 500);
                        };

                        isSpeaking = true;
                        window.speechSynthesis.speak(utterance);
                    } catch (e) {
                        console.error(`TTS initialization error for segment ${currentSegment}:`, e);
                        element.classList.add('visible');
                        if (isListItem) {
                            const parent = document.getElementById('intro-2');
                            if (parent) parent.classList.add('visible');
                        }
                        isSpeaking = false;
                        currentSegment++;
                        setTimeout(speakNext, 500);
                    }
                };
                speakNext();
            } else {
                console.warn('SpeechSynthesis not supported; revealing text progressively');
                introSegments.forEach(({ elementId, isListItem }, i) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        setTimeout(() => {
                            element.classList.add('visible');
                            if (isListItem) {
                                const parent = document.getElementById('intro-2');
                                if (parent) parent.classList.add('visible');
                            }
                        }, i * 1500);
                    }
                });
                setTimeout(() => {
                    const startButton = document.getElementById('start-button');
                    if (startButton) {
                        startButton.classList.add('visible');
                        startButton.style.display = 'block';
                    }
                }, introSegments.length * 1500);
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        // Matter.js Setup
        const Engine = Matter.Engine,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Body = Matter.Body;

        const engine = Engine.create();
        engine.world.gravity.y = 1;

        // Game State
        let player, platforms = [], hazards = [], goals = [];
        let currentLevel = 1;
        let lives = 2;
        let isGameOver = false;
        let jelloTimer = 0;
        let isGrounded = false;
        let particles = [];
        let windTimer = 0;
        let inputBuffer = { left: false, right: false, jump: false, jumpStartTime: 0, time: 0 };
        let jumpCooldown = 0;
        let jumpBuffer = 0;
        let screenShake = 0;
        let tauntTimer = 0;
        let lastAction = null;
        let idleTimer = 0;
        let userCity = 'your city';
        let isSpeaking = false;
        let isBlackout = false;
        let blackoutTimer = 0;
        let blackoutCooldown = 0;
        const flashlight = document.getElementById('flashlight');
        const blackoutOverlay = document.getElementById('blackout-overlay');

        // Player Properties
        const playerRadius = 15;
        const jumpForce = -2.5; // Reduced for controlled jumps
        const moveSpeed = 3;
        const maxVelocity = 5;
        const maxVerticalVelocity = 6; // Tightened to prevent ceiling hits
        const inputDelay = 30;

        // Start Game - Modified to show notification instead
        if (startButton) {
            startButton.addEventListener('click', () => {
                // Show notification
                notificationBox.style.display = 'block';
                
                // Force disclaimer button to be visible
                disclaimerButton.style.display = 'block';
                disclaimerButton.style.animation = 'pulse 0.5s infinite alternate';
                
                // Scroll disclaimer into view if needed
                disclaimerButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });
        }

        // Flashlight movement
        canvas.addEventListener('mousemove', (e) => {
            if (isBlackout) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                flashlight.style.left = `${x - 100}px`;
                flashlight.style.top = `${y - 100}px`;
            }
        });

        // Blackout event
        function triggerBlackout() {
            if (blackoutCooldown <= 0 && !isBlackout && Math.random() < 0.003) {
                isBlackout = true;
                blackoutTimer = 300 + Math.random() * 300; // 5-10 seconds
                blackoutOverlay.style.opacity = '1';
                flashlight.style.display = 'block';
                
                // Blackout dialogue
                const blackoutTaunts = [
                    "Power outage detected! Emergency protocols activated!",
                    "System failure! Where's the IT department when you need them?",
                    "Blackout! This is why we can't meet our quarterly goals!",
                    "Power disruption! Your productivity metrics just dropped to zero!",
                    "Electrical failure! This better not affect the quarterly reports!"
                ];
                const taunt = blackoutTaunts[Math.floor(Math.random() * blackoutTaunts.length)];
                const tauntText = document.getElementById('taunt-text');
                if (tauntText) tauntText.textContent = taunt;
                speak(taunt, 1.2, 0.9);
            }
        }

        function updateBlackout() {
            if (isBlackout) {
                blackoutTimer--;
                if (blackoutTimer <= 0) {
                    isBlackout = false;
                    blackoutOverlay.style.opacity = '0';
                    flashlight.style.display = 'none';
                    blackoutCooldown = 1800; // 30 second cooldown
                    
                    // Power restored dialogue
                    const restoreTaunts = [
                        "Power restored. Get back to work!",
                        "Systems online. No excuses now!",
                        "Lights back on. Resume productivity immediately!",
                        "Emergency power engaged. Continue your tasks!",
                        "Backup generators activated. No more slacking!"
                    ];
                    const taunt = restoreTaunts[Math.floor(Math.random() * restoreTaunts.length)];
                    const tauntText = document.getElementById('taunt-text');
                    if (tauntText) tauntText.textContent = taunt;
                    speak(taunt, 1.1, 1.0);
                }
            } else {
                if (blackoutCooldown > 0) blackoutCooldown--;
            }
        }

        // Geolocation
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`);
                            const data = await response.json();
                            userCity = data.address.city || data.address.town || 'your city';
                            updateTaunt('location');
                        } catch {
                            userCity = 'your city';
                        }
                    },
                    () => {
                        userCity = 'your city';
                    }
                );
            } else {
                userCity = 'your city';
            }
        }
        getUserLocation();

        // Text-to-Speech for Taunts
        function speak(text, pitch = 1.1, rate = 1.0) {
            if (window.speechSynthesis && !isSpeaking) {
                window.speechSynthesis.cancel();
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.pitch = pitch;
                    utterance.rate = rate;
                    utterance.onend = () => {
                        isSpeaking = false;
                        tauntTimer = 600;
                    };
                    utterance.onerror = (e) => {
                        console.warn('Taunt TTS error:', e);
                        isSpeaking = false;
                        tauntTimer = 600;
                    };
                    isSpeaking = true;
                    window.speechSynthesis.speak(utterance);
                } catch (e) {
                    console.error('Taunt TTS initialization error:', e);
                    isSpeaking = false;
                    tauntTimer = 600;
                }
            }
        }

        // Corporate Taunts
        const taunts = [
            `Your KPIs in ${userCity} are abysmal!`,
            `${userCity}’s productivity metrics outshine yours!`,
            `You're dragging down ${userCity}’s quarterly goals!`,
            "Your vertical mobility lacks strategic alignment!",
            "That jump failed to meet performance benchmarks!",
            "Elevate your execution, not just your altitude!",
            "Your leaps are non-compliant with agility standards!",
            "Lateral movement detected—yet no progress!",
            "Your velocity is below Q4 projections!",
            "Streamline your workflow, not your sidesteps!",
            "Mobility without ROI is unacceptable!",
            "Risk management failure: hazard collision!",
            "You're accruing liability with every misstep!",
            "Hazards expose your operational weaknesses!",
            "Incident report filed for your incompetence!",
            "Inactivity violates our uptime SLA!",
            "Cease loafing—productivity is mandatory!",
            "Idle time logged; expect a performance review!",
            "Your stagnation threatens shareholder value!",
            "Your Q1 performance is under review!",
            "Synergy deficit detected in your actions!",
            "You're not meeting core competency thresholds!",
            "Realign your efforts with corporate objectives!",
            "This failure will be escalated to management!",
            "Your skillset is deprecated for this role!",
            "Low engagement metrics—step it up!",
            "You're hemorrhaging efficiency points!",
            "This is why we can't meet our OKRs!",
            "Your output is below industry standards!",
            `You're a liability to ${userCity}’s growth!`
        ];

        // Level Completion Voice Lines
        const completionTaunts = [
            "Level 1 cleared? HR will note this anomaly.",
            "Level 2 done? Unexpected compliance detected.",
            "Level 3 passed? Metrics slightly improved.",
            "Level 4 achieved? A fluke in performance.",
            "Level 5 complete? Minimal competency shown.",
            "Level 6 cleared? Temporary efficiency spike.",
            "Level 7 done? Noted for review, barely.",
            "Level 8 passed? Marginal progress recorded.",
            "Level 9 achieved? Outlier in your data.",
            "Level 10 complete? Stats defy expectations.",
            "Level 11 cleared? Performance review pending.",
            "Level 12 done? Uncharacteristic success.",
            "Level 13 passed? KPI spike, under scrutiny.",
            "Level 14 achieved? Temporary metrics boost.",
            "Level 15 complete? Efficiency marginally up.",
            "Level 16 cleared? Noted, but don't slack.",
            "Level 17 done? Performance mildly adequate.",
            "Level 18 passed? Results barely acceptable.",
            "Level 19 achieved? Stats under evaluation.",
            "Level 20 complete? Probationary success."
        ];

        function updateTaunt(action = null) {
            if ((tauntTimer <= 0 && !isSpeaking) || action) {
                const tauntBox = document.getElementById('taunt-box');
                if (tauntBox) {
                    tauntBox.classList.remove('visible');
                    setTimeout(() => {
                        let filteredTaunts = taunts;
                        if (action === 'jump') {
                            filteredTaunts = taunts.filter(t => t.includes('jump') || t.includes('vertical') || t.includes('leaps'));
                        } else if (action === 'move') {
                            filteredTaunts = taunts.filter(t => t.includes('move') || t.includes('velocity') || t.includes('sidesteps'));
                        } else if (action === 'hazard') {
                            filteredTaunts = taunts.filter(t => t.includes('hazard') || t.includes('collision') || t.includes('misstep'));
                        } else if (action === 'idle') {
                            filteredTaunts = taunts.filter(t => t.includes('idle') || t.includes('inactivity') || t.includes('loafing'));
                        } else if (action === 'location' && userCity !== 'your city') {
                            filteredTaunts = taunts.filter(t => t.includes(userCity));
                        }
                        const taunt = filteredTaunts.length > 0 ? filteredTaunts[Math.floor(Math.random() * filteredTaunts.length)] : taunts[Math.floor(Math.random() * taunts.length)];
                        const tauntText = document.getElementById('taunt-text');
                        if (tauntText) tauntText.textContent = taunt;
                        if (tauntBox) tauntBox.classList.add('visible');
                        speak(taunt);
                        tauntTimer = 900 + Math.random() * 300;
                        lastAction = action;
                    }, 500);
                }
            }
            tauntTimer--;
        }

        // Particle System
        function createParticles(x, y, count, color = 'rgba(0, 122, 255, 0.7)') {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 5,
                    vy: (Math.random() - 0.5) * 5,
                    radius: Math.random() * 4 + 1,
                    life: 1,
                    color
                });
            }
        }

        function updateParticles() {
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.03;
                p.radius *= 0.97;
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // Level Definitions - Adjusted to be more achievable
        const levels = [
            { // Level 1 - Basic introduction
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 100, h: 15, friction: 0.3 },
                    { x: 400, y: 400, w: 100, h: 15, friction: 0.3 },
                    { x: 600, y: 340, w: 100, h: 15, friction: 0.3 }
                ],
                hazards: [],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 2 - Basic platforming
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 80, h: 15, friction: 0.3 },
                    { x: 400, y: 400, w: 80, h: 15, friction: 0.3 },
                    { x: 600, y: 340, w: 80, h: 15, friction: 0.3 }
                ],
                hazards: [],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 3 - Introduce hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 80, h: 15, friction: 0.4 },
                    { x: 400, y: 400, w: 80, h: 15, friction: 0.4 },
                    { x: 600, y: 340, w: 80, h: 15, friction: 0.4 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 4 - Introduce fragile platforms
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.2, isFragile: true },
                    { x: 350, y: 400, w: 60, h: 15, friction: 0.2 },
                    { x: 550, y: 340, w: 60, h: 15, friction: 0.2 }
                ],
                hazards: [],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 5 - Introduce moving hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 400, y: 400, w: 60, h: 15, friction: 0.3 },
                    { x: 600, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 6 - Introduce shrinking platforms
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 80, h: 15, friction: 0.4, isShrinking: true },
                    { x: 400, y: 400, w: 80, h: 15, friction: 0.4 },
                    { x: 600, y: 340, w: 80, h: 15, friction: 0.4 }
                ],
                hazards: [],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 7 - Combine hazards and fragile platforms
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3, isFragile: true },
                    { x: 500, y: 400, w: 60, h: 15, friction: 0.3 },
                    { x: 300, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 8 - More hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 500, y: 400, w: 60, h: 15, friction: 0.3 },
                    { x: 300, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 400, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 9 - Shrinking platforms with hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 300, y: 400, w: 60, h: 15, friction: 0.3, isShrinking: true },
                    { x: 400, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 250, y: 450, w: 50, h: 50 },
                    { x: 300, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 500, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 10 - Introduce moving platforms
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3, isMoving: true, range: { start: 150, end: 350, speed: 2 } },
                    { x: 400, y: 400, w: 60, h: 15, friction: 0.3 },
                    { x: 600, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 150, w: 30, h: 30, isMoving: true, range: { start: 550, end: 650, speed: 2 } },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 11 - More complex platform arrangement
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 100, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 500, y: 400, w: 60, h: 15, friction: 0.3 },
                    { x: 300, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 12 - Multiple hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3, isFragile: true },
                    { x: 500, y: 400, w: 60, h: 15, friction: 0.3 },
                    { x: 300, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 400, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 13 - Shrinking platforms with hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 300, y: 400, w: 60, h: 15, friction: 0.3, isShrinking: true },
                    { x: 400, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 250, y: 450, w: 50, h: 50 },
                    { x: 300, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 500, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 14 - Fast moving hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 50, h: 15, friction: 0.4, isFragile: true },
                    { x: 600, y: 340, w: 50, h: 15, friction: 0.4 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, isMoving: true, range: { start: 250, end: 450, speed: 3 } }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 15 - Moving goal with hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 50, h: 15, friction: 0.4, isShrinking: true },
                    { x: 400, y: 400, w: 50, h: 15, friction: 0.4 },
                    { x: 600, y: 340, w: 50, h: 15, friction: 0.4 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30, isMoving: true, range: { start: 650, end: 750, speed: 3 } },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 16 - Bouncy hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3, isFragile: true },
                    { x: 500, y: 400, w: 60, h: 15, friction: 0.3 },
                    { x: 300, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50, restitution: 1.5 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 17 - Complex platform arrangement
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 600, y: 400, w: 60, h: 15, friction: 0.3, isShrinking: true },
                    { x: 400, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 400, y: 450, w: 50, h: 50 },
                    { x: 450, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 18 - Fragile platforms with moving goal
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 500, y: 400, w: 60, h: 15, friction: 0.3, isFragile: true },
                    { x: 300, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 350, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 600, y: 150, w: 30, h: 30, isMoving: true, range: { start: 550, end: 650, speed: 3 } },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 19 - Multiple hazards
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 200, y: 480, w: 60, h: 15, friction: 0.3 },
                    { x: 400, y: 400, w: 60, h: 15, friction: 0.3, isShrinking: true },
                    { x: 600, y: 340, w: 60, h: 15, friction: 0.3 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 400, y: 400, w: 50, h: 50 },
                    { x: 500, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30 },
                playerStart: { x: 50, y: 527.5 }
            },
            { // Level 20 - Final challenge
                platforms: [
                    { x: 50, y: 550, w: 100, h: 15, friction: 0.5, restitution: 0, isStatic: true },
                    { x: 100, y: 480, w: 50, h: 15, friction: 0.05, isMoving: true, range: { start: 100, end: 250, speed: 4 } },
                    { x: 400, y: 400, w: 50, h: 15, friction: 0.4, isFragile: true },
                    { x: 600, y: 340, w: 50, h: 15, friction: 0.4 }
                ],
                hazards: [
                    { x: 300, y: 450, w: 50, h: 50 },
                    { x: 500, y: 400, w: 50, h: 50 }
                ],
                goal: { x: 700, y: 150, w: 30, h: 30, isMoving: true, range: { start: 650, end: 750, speed: 4 } },
                playerStart: { x: 50, y: 527.5 }
            }
        ];

        function loadLevel(levelIndex) {
            console.log(`Loading level ${levelIndex}`);
            World.clear(engine.world);
            platforms = [];
            hazards = [];
            goals = [];
            isGrounded = false;
            particles = [];
            jumpCooldown = 0;
            jumpBuffer = 0;

            const level = levels[Math.min(levelIndex - 1, levels.length - 1)];

            player = Bodies.circle(level.playerStart.x, level.playerStart.y, playerRadius, {
                friction: 0.5,
                frictionAir: 0.18, // Increased to dampen air movement
                restitution: 0.4,
                density: 0.0025
            });
            Body.setVelocity(player, { x: 0, y: -0.1 }); // Small upward velocity to settle on platform
            World.add(engine.world, player);

            level.platforms.forEach(p => {
                const platform = Bodies.rectangle(p.x + p.w / 2, p.y - p.h / 2, p.w, p.h, {
                    isStatic: p.isStatic || !p.isMoving,
                    friction: p.friction || 0.5,
                    restitution: p.restitution || 0.2, // Added restitution for bounce
                    collisionFilter: { group: 0 }
                });
                
                // For moving platforms, make them bounce off walls
                if (p.isMoving) {
                    platform.restitution = 0.5;
                    platform.collisionFilter.group = -1; // Prevent collision with other moving platforms
                }
                
                platforms.push({ 
                    body: platform, 
                    ...p, 
                    originalW: p.w, 
                    shrinkTimer: 0, 
                    fragileTimer: p.isFragile ? 60 : null,
                    isMoving: p.isMoving || false,
                    dir: p.isMoving ? p.range.speed : 0
                });
                World.add(engine.world, platform);
            });
            console.log(`Platforms loaded: ${platforms.length}`);

            level.hazards.forEach(h => {
                const hazard = Bodies.rectangle(h.x + h.w / 2, h.y - h.h / 2, h.w, h.h, {
                    isStatic: !h.isMoving,
                    isSensor: true,
                    restitution: h.restitution || 0
                });
                hazards.push({ body: hazard, ...h });
                World.add(engine.world, hazard);
            });

            const goal = Bodies.rectangle(level.goal.x + level.goal.w / 2, level.goal.y - level.goal.h / 2, level.goal.w, level.goal.h, {
                isStatic: !level.goal.isMoving,
                isSensor: true
            });
            goals.push({ body: goal, ...level.goal });
            World.add(engine.world, goal);
        }

        // Input Handling
        window.addEventListener('keydown', e => {
            if (e.code === 'ArrowLeft') {
                inputBuffer.left = true;
                updateTaunt('move');
            }
            if (e.code === 'ArrowRight') {
                inputBuffer.right = true;
                updateTaunt('move');
            }
            if (e.code === 'Space') {
                inputBuffer.jump = true;
                inputBuffer.jumpStartTime = Date.now(); // Track jump start time
                jumpBuffer = 12;
                updateTaunt('jump');
            }
            inputBuffer.time = Date.now();
            idleTimer = 0;
        });
        window.addEventListener('keyup', e => {
            if (e.code === 'ArrowLeft') inputBuffer.left = false;
            if (e.code === 'ArrowRight') inputBuffer.right = false;
            if (e.code === 'Space') inputBuffer.jump = false;
        });

        canvas.addEventListener('mousedown', e => e.preventDefault());
        canvas.addEventListener('click', e => e.preventDefault());
        canvas.addEventListener('contextmenu', e => e.preventDefault());

        const restartButton = document.getElementById('restart');
        if (restartButton) {
            restartButton.addEventListener('click', () => {
                lives = 2;
                currentLevel = 1;
                isGameOver = false;
                loadLevel(currentLevel);
                updateTaunt();
            });
        }

        Matter.Events.on(engine, 'collisionStart', event => {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if (!bodyA || !bodyB) return;
                if (bodyA === player || bodyB === player) {
                    const other = bodyA === player ? bodyB : bodyA;
                    if (hazards.some(h => h.body === other)) {
                        lives--;
                        updateTaunt('hazard');
                        if (lives <= 0) {
                            isGameOver = true;
                        } else {
                            Body.setPosition(player, levels[currentLevel - 1].playerStart);
                            Body.setVelocity(player, { x: 0, y: -0.1 });
                            createParticles(player.position.x, player.position.y, 15, 'rgba(255, 61, 61, 0.7)');
                        }
                    }
                    if (goals.some(g => g.body === other)) {
                        const taunt = completionTaunts[currentLevel - 1];
                        const tauntText = document.getElementById('taunt-text');
                        if (tauntText) tauntText.textContent = taunt;
                        const tauntBox = document.getElementById('taunt-box');
                        if (tauntBox) tauntBox.classList.add('visible');
                        speak(taunt, 0.9, 0.9);
                        currentLevel++;
                        if (currentLevel > levels.length) {
                            isGameOver = true;
                        } else {
                            loadLevel(currentLevel);
                            createParticles(player.position.x, player.position.y, 20, 'rgba(0, 255, 0, 0.7)');
                        }
                    }
                    const platform = platforms.find(p => p.body === other);
                    if (platform) {
                        isGrounded = true;
                        createParticles(player.position.x, player.position.y + playerRadius, 8);
                        if (platform.isFragile && platform.fragileTimer === null) {
                            platform.fragileTimer = 60;
                            screenShake = 10;
                        }
                    }
                }
            });
        });

        Matter.Events.on(engine, 'collisionEnd', event => {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if (!bodyA || !bodyB) return;
                if (pair.bodyA === player || pair.bodyB === player) {
                    if (platforms.some(p => p.body === (pair.bodyA === player ? pair.bodyB : pair.bodyA))) {
                        isGrounded = false;
                    }
                }
            });
        });

        function updateMovingObjects() {
            platforms.forEach(p => {
                if (p.isMoving) {
                    const range = p.range;
                    const currentX = p.body.position.x;
                    const speed = range.speed;
                    
                    // Bounce off canvas edges
                    if (currentX >= canvas.width - p.w/2) {
                        p.dir = -Math.abs(speed);
                    } else if (currentX <= p.w/2) {
                        p.dir = Math.abs(speed);
                    }
                    
                    Body.setVelocity(p.body, { x: p.dir || speed, y: 0 });
                }
            });

            hazards.forEach(h => {
                if (h.isMoving) {
                    const range = h.range;
                    const currentX = h.body.position.x;
                    const speed = range.speed;
                    if (currentX >= range.end) h.dir = -speed;
                    if (currentX <= range.start) h.dir = speed;
                    Body.setVelocity(h.body, { x: h.dir || speed, y: 0 });
                }
            });

            goals.forEach(g => {
                if (g.isMoving) {
                    const range = g.range;
                    const currentX = g.body.position.x;
                    const speed = range.speed * (Math.random() < 0.05 ? -1 : 1);
                    if (currentX >= range.end) g.dir = -Math.abs(speed);
                    if (currentX <= range.start) g.dir = Math.abs(speed);
                    Body.setVelocity(g.body, { x: g.dir || speed, y: 0 });
                }
            });
        }

        function updatePlatforms() {
            platforms.forEach(p => {
                if (p.isFragile && p.fragileTimer !== null) {
                    p.fragileTimer--;
                    if (p.fragileTimer <= 0) {
                        World.remove(engine.world, p.body);
                        platforms = platforms.filter(platform => platform !== p);
                        createParticles(p.body.position.x, p.body.position.y, 10);
                    }
                }
                if (p.isShrinking) {
                    p.shrinkTimer++;
                    p.w = Math.max(20, p.originalW - p.shrinkTimer * 0.1);
                    Body.scale(p.body, p.w / p.originalW, 1);
                    p.originalW = p.w;
                }
            });
        }

        function updateJelloEffect() {
            jelloTimer += 0.07;
            const scale = 1 + 0.07 * Math.sin(jelloTimer);
            player.jelloScale = scale;
        }

        function updateWind() {
            windTimer++;
            if (Math.random() < 0.01) {
                const windForce = (Math.random() - 0.5) * 0.05;
                Body.applyForce(player, player.position, { x: windForce, y: 0 });
                createParticles(player.position.x, player.position.y, 5, 'rgba(255, 255, 255, 0.3)');
            }
        }

        function keepPlayerInBounds() {
            const pos = player.position;
            if (pos.x < playerRadius) Body.setPosition(player, { x: playerRadius, y: pos.y });
            if (pos.x > canvas.width - playerRadius) Body.setPosition(player, { x: canvas.width - playerRadius, y: pos.y });
            if (pos.y < 50) {
                Body.applyForce(player, player.position, { x: 0, y: 0.01 }); // Push down near ceiling
                Body.setPosition(player, { x: pos.x, y: 50 });
            }
            if (pos.y > canvas.height) {
                lives--;
                updateTaunt('hazard');
                if (lives <= 0) {
                    isGameOver = true;
                } else {
                    Body.setPosition(player, levels[currentLevel - 1].playerStart);
                    Body.setVelocity(player, { x: 0, y: -0.1 });
                    createParticles(player.position.x, player.position.y, 15, 'rgba(255, 61, 61, 0.7)');
                }
            }
        }

        function clampVelocity() {
            const vel = player.velocity;
            if (Math.abs(vel.y) > maxVerticalVelocity) {
                Body.setVelocity(player, { x: vel.x, y: Math.sign(vel.y) * maxVerticalVelocity });
            }
        }

        function gameLoop() {
            if (isGameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#fff';
                ctx.font = '48px -apple-system';
                ctx.textAlign = 'center';
                ctx.fillText(lives <= 0 ? 'Game Over!' : 'You Win!', canvas.width / 2, canvas.height / 2);
                return;
            }

            try {
                Engine.update(engine, 1000 / 60);

                const now = Date.now();
                if (now - inputBuffer.time >= inputDelay) {
                    let vx = player.velocity.x;
                    if (inputBuffer.left) {
                        vx = -moveSpeed;
                    } else if (inputBuffer.right) {
                        vx = moveSpeed;
                    } else {
                        vx *= 0.7;
                    }
                    Body.setVelocity(player, { x: Math.max(-maxVelocity, Math.min(maxVelocity, vx)), y: player.velocity.y });

                    if (inputBuffer.jump && jumpBuffer > 0 && isGrounded && jumpCooldown <= 0) {
                        const jumpDuration = now - inputBuffer.jumpStartTime;
                        const appliedForce = jumpDuration < 200 ? -1.5 : jumpForce; // Variable jump height
                        Body.applyForce(player, player.position, { x: 0, y: appliedForce });
                        isGrounded = false;
                        jumpCooldown = 12;
                        jumpBuffer = 0;
                        createParticles(player.position.x, player.position.y + playerRadius, 12);
                    }
                }
                if (jumpCooldown > 0) jumpCooldown--;
                if (jumpBuffer > 0) jumpBuffer--;

                if (!inputBuffer.left && !inputBuffer.right && !inputBuffer.jump) {
                    idleTimer++;
                    if (idleTimer > 180) {
                        updateTaunt('idle');
                        idleTimer = 0;
                    }
                } else {
                    idleTimer = 0;
                }

                updateMovingObjects();
                updatePlatforms();
                updateJelloEffect();
                updateWind();
                updateParticles();
                updateTaunt();
                updateBlackout();
                triggerBlackout();
                keepPlayerInBounds();
                clampVelocity();

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, 'rgba(74, 74, 74, 0.5)');
                gradient.addColorStop(1, 'rgba(44, 44, 44, 0.5)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                drawParticles();

                platforms.forEach(p => {
                    ctx.fillStyle = p.isFragile ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.15)';
                    ctx.beginPath();
                    ctx.rect(p.body.position.x - p.w / 2, p.body.position.y - p.h / 2, p.w, p.h);
                    ctx.fill();
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.stroke();
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.2)';
                    ctx.shadowBlur = 10;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });

                hazards.forEach(h => {
                    ctx.fillStyle = `rgba(255, 61, 61, ${0.8 + 0.2 * Math.sin(jelloTimer)})`;
                    ctx.beginPath();
                    ctx.rect(h.body.position.x - h.w / 2, h.body.position.y - h.h / 2, h.w, h.h);
                    ctx.fill();
                    ctx.shadowColor = 'rgba(255, 61, 61, 0.5)';
                    ctx.shadowBlur = 15;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });

                goals.forEach(g => {
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                    ctx.beginPath();
                    ctx.rect(g.body.position.x - g.w / 2, g.body.position.y - g.h / 2, g.w, g.h);
                    ctx.fill();
                    ctx.shadowColor = 'rgba(0, 255, 0, 0.5)';
                    ctx.shadowBlur = 15;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });

                ctx.fillStyle = '#007aff';
                ctx.beginPath();
                const scale = player.jelloScale || 1;
                ctx.save();
                ctx.translate(player.position.x, player.position.y);
                ctx.scale(scale, 1 / scale);
                ctx.arc(0, 0, playerRadius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.stroke();
                ctx.shadowColor = 'rgba(0, 122, 255, 0.5)';
                ctx.shadowBlur = 20;
                ctx.fill();
                ctx.shadowBlur = 0;
                ctx.restore();

                const ui = document.getElementById('ui');
                if (ui) ui.textContent = `Level: ${currentLevel} | Lives: ${lives}`;

            } catch (e) {
                console.error('Game loop error:', e);
            }

            requestAnimationFrame(gameLoop);
        }

        initializeStartScreen();
        speakIntro();
    </script>
</body>
</html>
